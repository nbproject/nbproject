<!DOCTYPE html>
<html>
<head>
		<!-- Bootstrap -->
	<script type="text/javascript" src="external_js/jquery-1.9.0.min.js"></script>
	<script type="text/javascript" src="js/bootstrap.min.js"></script>
	<script type="text/javascript" src="js/jquery.dotdotdot-1.5.7.js"></script>

	<link rel="stylesheet" type="text/css" href="corkboard_theme.css"/>
	<link rel="stylesheet" type="text/css" href="task_list.css"/>
	<link rel="stylesheet" href="http://code.jquery.com/ui/1.10.2/themes/smoothness/jquery-ui.css" />
	<script type="text/javascript" src="external_js/jquery-ui-1.10.0.custom.min.js"></script>
	<script type="text/javascript" src="external_js/date.js"></script>
	<script type="text/javascript" src="static_js/task.js"></script>
	<link href='http://fonts.googleapis.com/css?family=Quicksand' rel='stylesheet' type='text/css'>
	<link rel="stylesheet" type="text/css" href="task_completion.css" />


	<script type="text/javascript">

	//wrapper tracing function
	var popup = false;
	var popupCount = 0;
	function line(txt){
		console.log(txt);
	}

	function showPopup(){
		$("#popContainer").show();
		taskPopupRefresh();
		popup = true;
	}

	function hidePopup(){
		$("#popContainer").hide();
		popup = false;
	}

	function taskClaimed(id, imgurl){
		line("--taskClaimed--: " + id);
		hidePopup();
		var item = $("#taskContainer #" + id);
		item.css("background-color", "#77D");
		item.find(".taskRowInner").css("border", "1px solid #336");
		item.find(".taskDue").html("Working!")
		var complete = item.find(".taskComplete");
		complete.html("<img src='" + imgurl + "'/>");
	}

	function taskCompleted(id, imgurl){
		line("--taskComplete--: " + id);
		hidePopup();
		var item = $("#taskContainer #" + id);
		item.css("background-color", "#7D7");
		item.find(".taskRowInner").css("border", "1px solid #363");
		item.find(".taskDue").html("Complete!");		
		var complete = item.find(".taskComplete");
		complete.html("<img src='" + imgurl + "' />");
	}

	function taskClick(){
		if (editModeOn) {
			return;
		}		
		console.log($(this));
		var id = $(this).parent().parent().attr("id");
		console.log(parent);
		task = tasks[id];
		showPopup();
	}	

	var beforeEditHTML = "";
	var editModeOn = false;
	function updateTaskList(task){
		var template = $("#taskRowTemplate");
		var container = $("#taskContainer");
		var taskDiv = template.clone().attr('id', task.id);			
		taskDiv.prependTo(container);
		var complete = $(taskDiv).find(".taskComplete");		
		var label = taskDiv.find(".taskLabel");
		label.attr("id", "l" + task.id);
		label.html(task.name);
		var taskDue = taskDiv.find(".taskDue");	
		taskDue.attr("id", "d" + task.id);	
		taskDue.html("Due: " + task.duedate);
		attachLabelListener(label);

		var button = taskDiv.find(".taskButton");
		console.log(button);
		$(button).click( taskClick);

	}

	function attachLabelListener(label) {
		$(label).click(function(e){
			if (editModeOn) {
				return;
			}
			editModeOn = true;
			var beforeText = $(this).text();
			var labelText = label.text();
			beforeEditHTML = label.html();
			label.html("<input type='text' value='" + labelText + "'>");
			label.html("<input id = 'curEdit' type = 'text' value='" + labelText + "'>");
			$("#curEdit").focus();

			$("#curEdit").keyup(function(e){
				if (editModeOn) {
					if(e.keyCode == 13){
		  				var inputText = $(this).val();
		  				label.html(beforeEditHTML);
		  				label.text(inputText);
		  				editModeOn = false;
		  				editButtonVisible = false;
					}			
				}
			});

		});
	}

	
	function validateTaskInput() {
		var form = $('form#new_task');
		var txtinput = form.find('[name="taskname"]');
		var dueinput = form.find('[name="due"]');

		if (txtinput.val().trim().length == 0) {
			//txtinput.blur_reset();
			txtinput.css('color', 'red');
			txtinput.css('font-weight', 'bold');
			return false;
		}
		return true;
	}

	function taskPopupRefresh() {
		document.getElementById("taskName").innerHTML = task.name;
	}

	function taskPopupInit() {
		// Set task variable
    	//var task = new Task('Dummy Task', 1);
    	
    	// Display Task Name
    	//document.getElementById("taskName").innerHTML = task.name;
    
    	// Disable buttons
    	document.getElementById('btnClaim').disabled = true;
    	document.getElementById('btnComplete').disabled = true;
    	
    	var currently_selected = '';
    	
    	// Selects a family member when clicked
    	$('.selectionCell').click(function(evt) {
    		currently_selected = evt.target.id;
    		if (!currently_selected)
    			return;
    		document.getElementById("selectedName").innerHTML = currently_selected;
    		$('.selectionPic').css('border-width', '0px');
    		$('.selectionPic').css('margin', '3px');
    		$('#'+currently_selected).css('border-width', '3px');
    		$('#'+currently_selected).css('margin', '0px');
    		$('#selectedPerson').attr('src', 'assets/'+currently_selected+'.jpg');

    		//$('#buttonTable').css('margin-top', '14px');
    		document.getElementById('btnClaim').disabled = false;
    		document.getElementById('btnComplete').disabled = false;
    	});
    	
		// Cancel Button
		$('#btnCancel').click(function(evt) {
    		hidePopup();
    	});
    	
    	// Claim Button
		$('#btnClaim').click(function(evt) {
    		task.status = 'claimed';
    		task.assignedTo = currently_selected;
    		var imgurl = 'assets/'+currently_selected+'.jpg';
    		taskClaimed(task.id, imgurl);
    	});
    	
    	// Complete Button
		$('#btnComplete').click(function(evt) {
    		task.status = 'completed';
    		task.assignedTo = currently_selected;
    		task.finished = currently_selected;
    		var imgurl = 'assets/'+currently_selected+'.jpg';
    		taskCompleted(task.id, imgurl);
    	});

	}
	(function($) {
		$(function() {

			// Handle the input field defaults.
			//$('.remember').blur_default();

			// Insert weekdays from tomorrow till a week from today.
			var duedd = $('#due');
			var day_start = (2).day().fromNow();
			for (var i = 0; i < 5; ++i) {
				var day_name = day_start.toString('dddd');
				duedd.append('<option value="'+day_name+'">Due: '
					+day_name+'</option>');
				day_start = day_start.add(1).day();
			}

			var id = 0;
			var form = $('form#new_task');
			tasks = new Array();
			form.submit(function(e) {
				e.preventDefault();
				var taskInput = form.find('[name="taskname"]');
				var taskTxt = taskInput.val();
				var taskDue = form.find('[name="due"]').val();

				if (taskTxt.trim().length == 0) {
					taskInput.addClass('error');
					return;
				} else {
					taskInput.removeClass('error');
				}

				var task = new Task(taskTxt, null,id);
				
				task.duedate = taskDue;
				tasks[id.toString()] = task;
				updateTaskList(task);
				taskInput.val('');
				++id;
			});
			
			$('.profile').click(function(evt) {
    			window.location = 'member_history.html?member=' + evt.target.id.slice(3);
    		});
    		
    		$(document).click(function() {
    			if (popup) {
    				popupCount +=1;
    				if (popupCount > 1) {
    					hidePopup();
    					popupCount = 0;
    				}

    			}
    		});

    		$("#popup").click(function(e) {
    			e.stopPropagation();
    		});

    		$('#titleButton').click(function(evt) {
    			window.location = 'index.html';
    		});

    		$("#popClose").click(function(evt){
    			
    		});
    		taskPopupInit();
    		/*
    		$(".labelWrapper").dotdotdot({
				//	configuration goes here
				ellipsis: '... '
			}); */
	    });
	})(jQuery);
	</script>
	<title>Household Dashboard</title>
</head>
<body>
	<div id="outer">
	<div id="content">
		<div style="position: relative;" id="titleButton">
			<img class="pin_left" src="assets/pushpin.png">
			<h1>Household Dashboard</h1>
		</div>
		<div id="navigation">
			<div class="tabs_container">
				<ul id="tabs">
					<li>To-Do</li>
				</ul>
			</div>
			<div class="family_container">
				<ul id="family">
					<li><div class="profile" id="boxCersei"><img src="assets/Cersei.jpg" id="picCersei"><h3>Cersei</h3></div></li>
					<li><div class="profile" id="boxRobert"><img src="assets/Robert.jpg" id="picRobert"><h3>Robert</h3></div></li>
					<li><div class="profile" id="boxJoffrey"><img src="assets/Joffrey.jpg" id="picJoffrey"><h3>Joffrey</h3></div></li>
					<li><div class="profile" id="boxMyrcella"><img src="assets/Myrcella.jpg" id="picMyrcella"><h3>Myrcella</h3></div></li>
					<li><div class="profile" id="boxTommen"><img src="assets/Tommen.jpg" id="picTommen"><h3>Tommen</h3></div></li>
				</ul>
			</div>
		</div>

		<div id="tasklist">

			<div>
				<h2>To-Do</h2>
			</div>
			<div id="item_entry">
				<form id="new_task" target="index.html">
					<!--<button>?</button>-->
					<input autofocus="autofocus" class="remember" type="text" name="taskname" placeholder="Enter Task Name">
					<!-- <label for="due">Due</label>-->
					<select name="due" id="due">
						<option value="ASAP">Due: ASAP</option>
						<option value="Today">Due: Today</option>
						<option value="Tomorrow">Due: Tomorrow</option>
						<!-- Javascript will add next 5 days -->
					</select>
					<button id="add_task">Add</button>
				</form>
			</div>
			<div id="taskContainer">
				<div id="taskRowTemplate" class="taskRow" >
					<div class="taskRowInner">
						<div class="taskComplete"></div>
						<p class="taskLabel"></p>
						<div class="taskDue"></div>
						<button class="taskButton">Claim</button>
					</div>
				</div>
			</div>		
		</div>
	</div>
	<div id="popContainer">
		<div id="popup">
			<div id="taskPopup">
				<div id="completionWindow">

					<span id="taskName">Task Name</span>
					<br>

					<img src="assets/unknown_person.jpg" id="selectedPerson"></img>
					<br>

					<span id="selectedName">Select Family Member</span>
					<br>

					<table id="selectionTable"><tr>

						<td class="selectionCell"><img src="assets/Cersei.jpg" class="selectionPic" id="Cersei" /></td>
						<td class="selectionCell"><img src="assets/Robert.jpg" class="selectionPic" id="Robert" /></td>
						<td class="selectionCell"><img src="assets/Joffrey.jpg" class="selectionPic" id="Joffrey" /></td>
						<td class="selectionCell"><img src="assets/Myrcella.jpg" class="selectionPic" id="Myrcella" /></td>
						<td class="selectionCell"><img src="assets/Tommen.jpg" class="selectionPic" id="Tommen" /></td>

					</tr></table>
					<br>

					<table id="buttonTable"><tr>

						<td><input id="btnCancel" class="completeButton" type="button" name="new" value="Cancel"/></td>

						<td><input id="btnClaim" class="completeButton" disabled="true" type="button" name="new" value="I'm Working On It!"/></td>

						<td><input id="btnComplete" class="completeButton" disabled="true" type="button" name="new" value="I'm Finished!"/></td> 


					</tr></table>

				</div>
			</div>
		<div>
		</div>
	</div>
</body>
</html>
