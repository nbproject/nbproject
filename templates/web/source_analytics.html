<!DOCTYPE html>
<html class="nb_fullscreen">
  <head>
<!--
   Author: cf AUTHORS.txt 
   License:  Copyright (c) 2010-2012 Massachusetts Institute of Technology.
   MIT License (cf. MIT-LICENSE.txt or http://www.opensource.org/licenses/mit-license.php)
  -->
    <title>NB Analytics</title>
    <link type="text/css" href="/content/compiled/docanalytics.css" rel="stylesheet" />
    <script type="text/javascript" src="/content/compiled/docanalytics_NB.js"></script>
    <script type="text/template" id="page-template">
      <img class="page-img" id="page-img-<%= page_num %>" src="<%= img_url %>">
      <span class="page-num"><%= page_num %></span>
      <div class="page-stats">
        <span class="num-threads"><%= num_threads %></span> threads
        <br/><span class="num-annotations"><%= num_annotations %></span> annotations
        <br/><span class="num-questions"><%= num_questions %></span> questions
      </div>
      <div class="clearfix"></div>
    </script>
    <script type="text/template" id="highlight-template">
      <div class="highlight" style="top:<%= y %>px; left:<%= x %>px; width: <%= w %>px; height: <%= h %>px;"></div>
    </script>

    <script>
      var PageView = Backbone.View.extend({
        
        tagName: 'div',
        className: 'page-wrap',
        id: function() {
          return 'page-'+this.model.attributes.page_num;
        },
        template: _.template(jQuery("#page-template").html()),

        render: function(){
          jQuery(this.el).append(this.template(this.model.attributes));
          return this;
        },

      });

      var HighlightView = Backbone.View.extend({
        initialize: function() {
          this.render();
        },
        el: function() {
          if (this.model) {
            return "#page-"+this.model.attributes.page_num;
          }
        },
        template: _.template(jQuery("#highlight-template").html()),
        render: function(){
          // TODO: better way to calculate variables?
          var pgHtLg = 1045;
          var pgHtSm = 220; // set in ui.docAnalytiscView.css
          var s = 1.577; // calculated complicatedly
          var s2 = pgHtSm/(s*pgHtLg);
          var m = this.model.attributes;
          jQuery(this.el).append(this.template({
            'x': m.x*s2,
            'y': m.y*s2,
            'w': m.w*s2,
            'h': m.h*s2
          }));
        }
      });

      var DocumentView = Backbone.View.extend({

        initialize: function() {
          var _this = this;
          this._pageViews = [];

          this.collection.each(function(page) {
            _this._pageViews.push(new PageView({
              model: page,
            }));
          });

          this.collection.on('all', function() {
            _this.reorder();
          })
        },

        // type is 'annotations' or 'questions'
        filterByPropertyAndNum: function(property, num) {
          var tag = "."+property;
          jQuery(".page-wrap").show()
                              .each(function(index, value) {
                                var el = jQuery(this);
                                var val = el.find(tag).html();
                                if (val <= num) {
                                  el.hide();
                                }
                              });
        },

        reorder: function() {
          for(var i=0; i < this.collection.length; i++) {
            var pg = this.collection.at(i).attributes.page_num;
            var currentEl = jQuery("#page-"+pg);
            jQuery(this.el).append(currentEl);            
          }
        },

        render: function() {
          var _this = this;
          var fragment = document.createDocumentFragment();
          _(this._pageViews).each(function(pv) {
            fragment.appendChild(pv.render().el);
          })  
          jQuery(_this.el).html(fragment);
        }
      });

    </script>
    <script>
      (function($){
        $(document).ready(function() {
            var pages = {{ pages|safe }};
            var highlights = {{ highlights|safe }};
            var doc = new Document();

            var page;
            for (var i=1; i <= {{ numpages }}; i++) {
              if (i in pages) {
                page = new Page(pages[i]);  
              } else {
                page = new Page({'page_num': i});
              }

              // TODO: better way to get the source ID/ckey?
              var img_server = "http://nb.mit.edu";
              var ckey = NB.conf.userinfo.ckey;
              var img_url = img_server + "/pdf/cache2/288/33/"+{{ source.id }}+"?ckey="+ckey+";page=" + i;
              page.set('img_url', img_url); // TODO: put img url in PageView?

              doc.add(page);
            };

            var documentView = new DocumentView({
              collection: doc,
              el: $("#pages-container")
            });
            documentView.render();

            for (h in highlights) {
              var highlight = new Highlight(highlights[h]);
              var highlightView = new HighlightView({ model: highlight});
            }

            $("#sort-by").on('change', function() {
              var attr = $(this).val();
              doc.sortByField(attr);
            })

            $("#show-filter").on('change', function() {
              var property = $(this).val();
              var num = 0; // TODO: make this flexible (another HTML property?)
              documentView.filterByPropertyAndNum(property, num);
            })
        });
      })(jQuery);
    </script>

  </head>
  <body>
    <div class='nb-viewport'><div class='nb-widget-header' style='height:24px;' /></div>
    <div class="main-wrapper">
      <h1>{{ source.title }}</h1>
      
      <div class="controls">
        <label>Show: </label>
        <select id="show-filter">
          <option value="all">All pages</option>
          <option value="num-annotations">Pages with annotations</option>
          <option value="num-questions">Pages with questions</option>
        </select>
      
        <label>Sort by: </label>
        <select id="sort-by">
          <option value="page_num">Page number</option>
          <option value="num_annotations">Number of annotations</option>
          <option value="num_questions">Number of questions</option>
        </select>
      </div>
      <div id="pages-container"></div>
      <div class="clearfix"></div>
    </div>

  </body>
</html>
