<!DOCTYPE html>
<html>
  <head>
<!--
   Author: cf AUTHORS.txt 
   License:  Copyright (c) 2010-2012 Massachusetts Institute of Technology.
   MIT License (cf. MIT-LICENSE.txt or http://www.opensource.org/licenses/mit-license.php)
  -->
    <title>NB Analytics</title>
    <link type="text/css" href="/content/compiled/docanalytics.css" rel="stylesheet" />
    <script type="text/javascript" src="/content/compiled/docanalytics_NB.js"></script>
    <script type="text/template" id="page-template">
          <div class="page-wrap" id="page-<%= page_num %>">
            <img class="page-img" id="page-img-<%= page_num %>" src="<%= img_url %>">
            <span class="page-num"><%= page_num %></span>
            <div class="page-stats">
              <%= num_annotations %> annotations
              <br/><%= num_questions %> questions
            </div>
            <div class="clearfix"></div>
          </div>
    </script>
    <script type="text/template" id="highlight-template">
      <div class="highlight" style="top:<%= y %>px; left:<%= x %>px; width: <%= w %>px; height: <%= h %>px;"></div>
    </script>

    <script>
      var PageView = Backbone.View.extend({
        initialize: function(){
          this.render();
        },

        el: "#pages-container",

        template: _.template(jQuery("#page-template").html()),

        render: function(){
          jQuery(this.el).append(this.template(this.model.attributes));
          return this;
        }
      });

      var HighlightView = Backbone.View.extend({
        initialize: function() {
          this.render();
        },
        el: function() {
          if (this.model) {
            console.log(this.model.attributes.page_num);
            return "#page-"+this.model.attributes.page_num;
          }
        },
        template: _.template(jQuery("#highlight-template").html()),
        render: function(){
          // TODO: update attributes (x, y, h, w) to match doc size
          var pgHtLg = 1045;
          var pgHtSm = 220; // set in ui.docAnalytiscView.css
          var s = 1.577; // calculated complicatedly
          var s2 = pgHtSm/(s*pgHtLg);
          var m = this.model.attributes;
          jQuery(this.el).append(this.template({
            'x': m.x*s2,
            'y': m.y*s2,
            'w': m.w*s2,
            'h': m.h*s2
          }));
        }
      })

      // var repaint = function(doc) {
      //   var docFrag = ne
      //   for (page in doc) {

      //   }
      // }

    </script>
    <script>
      (function($){
        $(document).ready(function() {
            var pages = {{ pages|safe }};
            var highlights = {{ highlights|safe }};
            console.log(highlights);
            var doc = new Document();

            var page;
            for (var i=1; i <= {{ numpages }}; i++) {
              if (i in pages) {
                page = new Page(pages[i]);  
              } else {
                page = new Page({'page_num': i});
              }

              // TODO: better way to get the source ID/ckey?
              var img_server = "http://localhost:8000";
              var ckey = NB.conf.userinfo.ckey;
              var img_url = img_server + "/pdf/cache2/288/33/"+{{ source_id }}+"?ckey="+ckey+";page=" + i;
              page.set('img_url', img_url); // TODO: put img url in PageView?

              var page_view = new PageView({ model: page });
              doc.add(page);
            }

            for (h in highlights) {
              var highlight = new Highlight(highlights[h]);
              var highlightView = new HighlightView({ model: highlight});
            }

            doc.sortByField('num_annotations');
            console.log(doc.toJSON());
        });
      })(jQuery);
    </script>

  </head>
  <body>
    Analytics 

    <div id="pages-container"></div>


  </body>
</html>
